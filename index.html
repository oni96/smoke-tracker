<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Smokeâ€‘Free Journey</title>
    <style>
      :root {
        --bg: #0f172a;         /* slate-900 */
        --card: #111827;       /* gray-900 */
        --muted: #94a3b8;      /* slate-400 */
        --text: #e5e7eb;       /* gray-200 */
        --accent: #22c55e;     /* green-500 */
        --accent-2: #10b981;   /* emerald-500 */
        --warning: #f59e0b;    /* amber-500 */
        --danger: #ef4444;     /* red-500 */
        --bar-bg: #1f2937;     /* gray-800 */
        --bar-fill: linear-gradient(90deg, #22c55e, #84cc16);
        --badge-bg: #0b1220;
        --milestone: #38bdf8;  /* sky-400 */
        --shadow: 0 6px 24px rgba(0,0,0,.35);
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        background: radial-gradient(1000px 600px at 20% -10%, #1f2937 0%, transparent 60%),
                    radial-gradient(1200px 800px at 120% 20%, #0b1220 0%, transparent 60%),
                    var(--bg);
        color: var(--text);
        font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        display: grid;
        place-items: center;
        padding: 24px;
      }

      .container {
        width: 100%;
        max-width: 980px;
        background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 16px;
        padding: 28px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(6px);
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }
      h1 {
        margin: 0;
        font-size: 28px;
        letter-spacing: 0.3px;
      }
      .since {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
      }

      .timer {
        display: grid;
        grid-template-columns: repeat(4, minmax(120px, 1fr));
        gap: 12px;
        margin: 16px 0 24px;
      }
      .time-card {
        background: var(--card);
        border: 1px solid rgba(255,255,255,0.06);
        padding: 16px 14px;
        border-radius: 12px;
        text-align: center;
      }
      .time-card .value {
        display: block;
        font-weight: 800;
        font-size: 32px;
        letter-spacing: 0.5px;
      }
      .time-card .label {
        color: var(--muted);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .progress-section h2,
      .achievements h2 {
        font-size: 18px;
        margin: 12px 0 8px;
      }

      .bar {
        height: 18px;
        background: var(--bar-bg);
        border-radius: 999px;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.06);
      }
      .fill {
        height: 100%;
        background: var(--bar-fill);
        width: 0%;
        transition: width 0.8s ease;
      }
      .progress-meta {
        margin-top: 8px;
        display: flex;
        justify-content: space-between;
        gap: 12px;
        color: var(--muted);
        font-size: 14px;
      }

      .achievements {
        margin-top: 18px;
      }
      .streak-line {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 8px;
      }
      .streak-count {
        display: inline-block;
        background: var(--badge-bg);
        border: 1px solid rgba(255,255,255,0.08);
        padding: 4px 10px;
        border-radius: 999px;
        color: var(--text);
      }

      .badges {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 10px;
      }
      .badge {
        background: var(--card);
        border: 1px solid rgba(255,255,255,0.06);
        padding: 10px 12px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .badge .title { font-weight: 600; }
      .badge .sub { color: var(--muted); font-size: 12px; }
      .check {
        width: 22px; height: 22px;
        border-radius: 50%;
        display: grid; place-items: center;
        color: #052e16;
        background: conic-gradient(from 180deg at 50% 50%, #34d399, #a3e635);
        border: 1px solid rgba(255,255,255,0.12);
        box-shadow: 0 2px 8px rgba(52,211,153,.35) inset;
      }
      .locked {
        opacity: 0.6;
        filter: grayscale(0.2);
      }
      .milestone .title { color: var(--milestone); }

      .celebrate {
        display: none;
        margin: 6px 0 0;
        color: var(--accent);
        font-weight: 600;
      }
      .celebrate.show {
        display: inline-block;
        animation: pop 1.2s ease forwards;
      }
      @keyframes pop {
        0% { transform: scale(0.9); opacity: 0; }
        50% { transform: scale(1.04); opacity: 1; }
        100% { transform: scale(1); opacity: 1; }
      }

      footer {
        margin-top: 20px;
        color: var(--muted);
        font-size: 12px;
        text-align: center;
      }

      /* Controls */
      .controls { display:flex; align-items:center; gap:10px; flex-wrap:wrap }
      .btn { cursor:pointer; border:1px solid rgba(255,255,255,0.12); background:#172554; color:#e5e7eb; padding:6px 10px; border-radius:8px; font-weight:600 }
      .input { background:#0b1220; color:#e5e7eb; border:1px solid rgba(255,255,255,0.1); border-radius:8px; padding:6px 10px }

      /* Collapsible */
      details { background: transparent; border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 8px 12px; }
      details > summary { cursor: pointer; list-style: none; font-weight: 600; color: var(--text); }
      details > summary::-webkit-details-marker { display:none; }
      .summary-row { display:flex; align-items:center; justify-content:space-between; gap:10px }
      .summary-sub { color: var(--muted); font-size: 12px }

      /* History */
      .history { margin-top: 18px; }
      .history .list { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
      .history .item { background: var(--card); border: 1px solid rgba(255,255,255,0.06); padding: 10px 12px; border-radius: 12px; }
      .history .item .title { font-weight: 600; }
      .history .item .sub { color: var(--muted); font-size: 12px; }

      @media (max-width: 640px) {
        .timer { grid-template-columns: repeat(2, minmax(120px, 1fr)); }
        header { flex-direction: column; align-items: flex-start; }
      }
    </style>
  </head>
  <body>
    <main class="container" role="main">
      <header>
        <h1>Smokeâ€‘Free Journey</h1>
        <div class="controls">
          <p class="since" id="sinceText" style="margin:0">Quit at â€”</p>
          <input type="datetime-local" class="input" id="startInput" aria-label="Set custom start date" />
          <button id="applyStartBtn" class="btn" title="Apply custom start date">Set start</button>
          <button id="resetBtn" class="btn" title="If you smoked, restart the timer">I slipped â€” reset timer</button>
        </div>
      </header>

      <section class="timer" aria-live="polite">
        <div class="time-card" aria-label="Days without smoking">
          <span class="value" id="days">0</span>
          <span class="label">Days</span>
        </div>
        <div class="time-card" aria-label="Hours without smoking">
          <span class="value" id="hours">0</span>
          <span class="label">Hours</span>
        </div>
        <div class="time-card" aria-label="Minutes without smoking">
          <span class="value" id="minutes">0</span>
          <span class="label">Minutes</span>
        </div>
        <div class="time-card" aria-label="Seconds without smoking">
          <span class="value" id="seconds">0</span>
          <span class="label">Seconds</span>
        </div>
      </section>

      <section class="progress-section" aria-labelledby="progressTitle">
        <h2 id="progressTitle">Today's Progress</h2>
        <div class="bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Progress to next daily achievement">
          <div class="fill" id="progressBar"></div>
        </div>
        <div class="progress-meta">
          <div>
            <strong>Completed days:</strong> <span id="completedDays">0</span>
            <span class="celebrate" id="celebrate">ðŸŽ‰ New achievement unlocked!</span>
          </div>
          <div id="toNextLabel">Next in â€”</div>
        </div>
      </section>

      <section class="achievements" aria-labelledby="achievementsTitle">
        <h2 id="achievementsTitle">Achievements</h2>
        <div class="streak-line">
          <span>Daily streak:</span>
          <span class="streak-count"><span id="streakDays">0</span> days</span>
        </div>
        <div class="badges" id="dailyAchievements" aria-label="Recent daily achievements"></div>
        <details id="milestonePanel" open>
          <summary>
            <div class="summary-row">
              <span>Milestones</span>
              <span class="summary-sub">Collapse or expand weekly goals</span>
            </div>
          </summary>
          <div style="height:8px"></div>
          <div class="badges" id="milestones" aria-label="Milestone achievements"></div>
        </details>
      </section>

      <section class="history" aria-labelledby="historyTitle">
        <h2 id="historyTitle">Slip History</h2>
        <p class="since">Total slips: <strong id="slipCount">0</strong></p>
        <div class="list" id="slipList"></div>
      </section>

      <footer>
        Keep going â€” your future self thanks you.
      </footer>
    </main>

    <script>
      // Default quit date/time here (local): 7:30 PM on 5th August 2025
      const DEFAULT_QUIT_AT = new Date(2025, 7, 5, 19, 30, 0);

      // Base milestone titles
      const BASE_MILESTONES = [
        { days: 1,   name: 'Smoke Free Agent ðŸ•µï¸' },
        { days: 3,   name: 'Craving Crusher ðŸ”¨' },
        { days: 7,   name: 'Week One Warrior ðŸ›¡ï¸' },
        { days: 14,  name: 'Fortnight Firewall ðŸ”¥' },
        { days: 30,  name: 'Bronze Lungs ðŸ¥‰' },
        { days: 90,  name: 'Silver Lungs ðŸ¥ˆ' },
        { days: 182, name: 'Nicotine Nemesis âš”ï¸' },
        { days: 365, name: 'Gold Lungs â€” Legend ðŸ¥‡' }
      ];

      // Build milestones every 7 days (from day 7) up to a horizon
      function buildMilestonesHorizon(maxDays = 365) {
        const map = new Map(BASE_MILESTONES.map(m => [m.days, m.name]));
        const weeks = Math.floor(maxDays / 7);
        for (let w = 1; w <= weeks; w++) {
          const d = w * 7;
          if (!map.has(d)) {
            map.set(d, `Weekly Streak: Week ${w} ðŸ…`);
          }
        }
        return Array.from(map.entries())
          .map(([days, name]) => ({ days, name }))
          .sort((a, b) => a.days - b.days);
      }

      const el = (id) => document.getElementById(id);
      const daysEl = el('days');
      const hoursEl = el('hours');
      const minutesEl = el('minutes');
      const secondsEl = el('seconds');
      const progressBar = el('progressBar');
      const toNextLabel = el('toNextLabel');
      const completedDaysEl = el('completedDays');
      const celebrateEl = el('celebrate');
      const sinceText = el('sinceText');
      const resetBtn = el('resetBtn');
      const startInput = el('startInput');
      const applyStartBtn = el('applyStartBtn');
      const slipCountEl = el('slipCount');
      const slipList = el('slipList');
      const streakDays = el('streakDays');
      const dailyAchievements = el('dailyAchievements');
      const milestonesWrap = el('milestones');

      const MS = { s: 1000, m: 60_000, h: 3_600_000, d: 86_400_000 };

      function pad(n) { return String(n).padStart(2, '0'); }

      function fmtHMSto(ms) {
        const total = Math.max(0, Math.floor(ms / 1000));
        const h = Math.floor(total / 3600);
        const m = Math.floor((total % 3600) / 60);
        const s = total % 60;
        return `${pad(h)}:${pad(m)}:${pad(s)}`;
      }

      function fmtDaysHMS(ms) {
        const d = Math.floor(ms / MS.d);
        const h = Math.floor((ms % MS.d) / MS.h);
        const m = Math.floor((ms % MS.h) / MS.m);
        const s = Math.floor((ms % MS.m) / MS.s);
        const parts = [];
        if (d) parts.push(`${d}d`);
        if (h || parts.length) parts.push(`${h}h`);
        if (m || parts.length) parts.push(`${m}m`);
        parts.push(`${s}s`);
        return parts.join(' ');
      }

      function renderMilestones(completedDays) {
        milestonesWrap.innerHTML = '';
        const list = buildMilestonesHorizon(365);
        for (const m of list) {
          const unlocked = completedDays >= m.days;
          const div = document.createElement('div');
          div.className = `badge milestone ${unlocked ? '' : 'locked'}`;
          div.innerHTML = `
            <div>
              <div class="title">${m.name}</div>
              <div class="sub">${unlocked ? 'Unlocked' : `Unlocks at Day ${m.days}`}</div>
            </div>
            <div class="check" aria-hidden="true">${unlocked ? 'âœ“' : 'â€¢'}</div>
          `;
          milestonesWrap.appendChild(div);
        }
      }

      function renderDaily(completedDays) {
        streakDays.textContent = completedDays;
        // Show the most recent 30 days as badges
        const start = Math.max(1, completedDays - 29);
        const end = completedDays;
        dailyAchievements.innerHTML = '';
        if (end < 1) {
          const empty = document.createElement('div');
          empty.className = 'badge locked';
          empty.innerHTML = '<div><div class="title">No quests yet</div><div class="sub">First quest unlocks at Day 1</div></div><div class="check">â€¢</div>';
          dailyAchievements.appendChild(empty);
          return;
        }
        for (let d = end; d >= start; d--) {
          const div = document.createElement('div');
          div.className = 'badge';
          div.innerHTML = `
            <div>
              <div class="title">Daily Quest #${d}</div>
              <div class="sub">Quest Complete</div>
            </div>
            <div class="check" aria-hidden="true">âœ“</div>
          `;
          dailyAchievements.appendChild(div);
        }
      }

      function initSinceText(date) {
        const opts = { dateStyle: 'medium', timeStyle: 'short' };
        try {
          sinceText.textContent = `Quit at ${new Intl.DateTimeFormat(undefined, opts).format(date)}`;
        } catch {
          sinceText.textContent = `Quit at ${date.toLocaleString()}`;
        }
      }

      let lastCompletedDays = -1;
      function getStoredQuitAt() {
        const raw = localStorage.getItem('quitAt');
        if (!raw) return DEFAULT_QUIT_AT;
        const d = new Date(raw);
        return isNaN(d.getTime()) ? DEFAULT_QUIT_AT : d;
      }

      let quitAt = getStoredQuitAt();

      function setQuitAt(date) {
        quitAt = date;
        try { localStorage.setItem('quitAt', date.toISOString()); } catch {}
        lastCompletedDays = -1; // force re-render of achievements
        initSinceText(quitAt);
        setStartInputFromDate(quitAt);
        update();
      }

      function loadSlips() {
        try {
          const raw = localStorage.getItem('slips');
          if (!raw) return [];
          const arr = JSON.parse(raw);
          return Array.isArray(arr) ? arr : [];
        } catch { return []; }
      }

      function saveSlips(arr) {
        try { localStorage.setItem('slips', JSON.stringify(arr)); } catch {}
      }

      function recordSlip(slipDate) {
        const slips = loadSlips();
        const duration = Math.max(0, slipDate.getTime() - quitAt.getTime());
        slips.push({ at: slipDate.toISOString(), streakMs: duration });
        saveSlips(slips);
        renderSlips();
      }

      function renderSlips() {
        const slips = loadSlips();
        slipCountEl.textContent = slips.length;
        slipList.innerHTML = '';
        if (!slips.length) {
          const empty = document.createElement('div');
          empty.className = 'item';
          empty.innerHTML = '<div class="title">No slips recorded</div><div class="sub">Stay strong â€” you got this</div>';
          slipList.appendChild(empty);
          return;
        }
        const opts = { dateStyle: 'medium', timeStyle: 'short' };
        for (let i = slips.length - 1; i >= 0; i--) {
          const s = slips[i];
          const when = new Date(s.at);
          const div = document.createElement('div');
          div.className = 'item';
          let whenText = '';
          try { whenText = new Intl.DateTimeFormat(undefined, opts).format(when); }
          catch { whenText = when.toLocaleString(); }
          div.innerHTML = `
            <div class="title">Slip on ${whenText}</div>
            <div class="sub">Streak before slip: ${fmtDaysHMS(s.streakMs)}</div>
          `;
          slipList.appendChild(div);
        }
      }

      function setStartInputFromDate(date) {
        // format YYYY-MM-DDTHH:mm in local time
        const yyyy = date.getFullYear();
        const mm = pad(date.getMonth() + 1);
        const dd = pad(date.getDate());
        const hh = pad(date.getHours());
        const mi = pad(date.getMinutes());
        startInput.value = `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
      }

      resetBtn.addEventListener('click', () => {
        const ok = confirm('Record a slip and reset the timer to now?');
        if (ok) { const now = new Date(); recordSlip(now); setQuitAt(now); }
      });

      applyStartBtn.addEventListener('click', () => {
        const val = startInput.value;
        if (!val) { alert('Please pick a date and time.'); return; }
        const d = new Date(val);
        if (isNaN(d.getTime())) { alert('Invalid date.'); return; }
        setQuitAt(d);
      });
      function update() {
        const now = new Date();
        const diff = now - quitAt;

        if (diff < 0) {
          // Pre-quit countdown
          const until = Math.abs(diff);
          daysEl.textContent = Math.floor(until / MS.d);
          hoursEl.textContent = Math.floor((until % MS.d) / MS.h);
          minutesEl.textContent = Math.floor((until % MS.h) / MS.m);
          secondsEl.textContent = Math.floor((until % MS.m) / MS.s);
          progressBar.style.width = '0%';
          progressBar.parentElement.setAttribute('aria-valuenow', '0');
          completedDaysEl.textContent = '0';
          toNextLabel.textContent = `Starts in ${fmtHMSto(until)}`;
          renderDaily(0);
          renderMilestones(0);
          return;
        }

        // Elapsed
        const completedDays = Math.floor(diff / MS.d);
        const remainder = diff % MS.d;
        const hours = Math.floor((diff % MS.d) / MS.h);
        const minutes = Math.floor((diff % MS.h) / MS.m);
        const seconds = Math.floor((diff % MS.m) / MS.s);

        daysEl.textContent = completedDays;
        hoursEl.textContent = hours;
        minutesEl.textContent = minutes;
        secondsEl.textContent = seconds;

        // Daily progress to next achievement
        const pct = Math.min(100, Math.max(0, (remainder / MS.d) * 100));
        progressBar.style.width = pct.toFixed(2) + '%';
        progressBar.parentElement.setAttribute('aria-valuenow', pct.toFixed(0));

        completedDaysEl.textContent = completedDays;

          const nextAt = new Date(quitAt.getTime() + (completedDays + 1) * MS.d);
        const toNext = Math.max(0, nextAt - now);
        toNextLabel.textContent = `Next daily achievement in ${fmtHMSto(toNext)}`;

        // Re-render achievements when day count changes
        if (completedDays !== lastCompletedDays) {
          renderDaily(completedDays);
          renderMilestones(completedDays);

          // Celebration ping when a new day is completed (skip on very first render if already >0)
          if (lastCompletedDays >= 0 && completedDays > lastCompletedDays) {
            celebrateEl.classList.remove('show');
            // force reflow
            void celebrateEl.offsetWidth;
            celebrateEl.classList.add('show');
            setTimeout(() => celebrateEl.classList.remove('show'), 4000);
          }
          lastCompletedDays = completedDays;
        }
      }

      initSinceText(quitAt);
      setStartInputFromDate(quitAt);
      renderSlips();
      update();
      // Update every second
      setInterval(update, 1000);
    </script>
  </body>
</html>
